<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Rival</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


</head>
<body>
<div class="main-container">
    <div class="match-display">
        <!-- Jugador 1 -->
        <div class="player-container">
            <div style="position: relative;">
                <div class="player-card"></div>
                <div class="player-avatar"
                     style="position: absolute; top: -75px; left: 50%; transform: translateX(-50%);">
                    <img th:src="${avatarImg}" alt="Perfil" class="profile-pic">
                    <div class="score-badge">
                        <span class="material-symbols--star-rounded"></span>
                        <span class="badge-number" th:text="${jugador.nivel}">27</span>
                    </div>
                </div>
                <div class="player-name" th:text="${jugador.nombreUsuario}">Usuario123</div>
            </div>
            <div class="counter-row">
                <div class="counter-item">
                    <div class="counter-circle">
                        <img th:src="@{/resources/imgs/bomb.png}" alt="Perfil" class="profile-pic">
                    </div>
                    <div class="counter-value">1</div>
                </div>
                <div class="counter-item">
                    <div class="counter-circle">
                        <img th:src="@{/resources/imgs/bomb.png}" alt="Perfil" class="profile-pic">
                    </div>
                    <div class="counter-value">1</div>
                </div>
                <div class="counter-item">
                    <div class="counter-circle">
                        <img th:src="@{/resources/imgs/bomb.png}" alt="Perfil" class="profile-pic">
                    </div>
                    <div class="counter-value">1</div>
                </div>
                <div class="counter-item">
                    <div class="counter-circle">
                        <img th:src="@{/resources/imgs/bomb.png}" alt="Perfil" class="profile-pic">
                    </div>
                    <div class="counter-value">1</div>
                </div>
            </div>
        </div>

        <!-- VS -->
        <div class="vs-display">
            VS
        </div>

        <!-- Jugador 2 (por encontrar) -->
        <div class="player-container">
            <div style="position: relative;">
                <div class="player-card"></div>
                <div class="player-avatar"
                     style="position: absolute; top: -75px; left: 50%; transform: translateX(-50%);">
                    <img id="rival-avatar" src="" alt="Avatar Rival" class="profile-pic" style="display:none;">
                    <div class="score-badge">
                        <span class="material-symbols--star-rounded"></span>
                        <span class="badge-number">?</span>
                    </div>
                    <div class="question-mark">?</div>
                </div>
                <div class="player-name rival-name">...</div>
            </div>
        </div>
    </div>

    <!-- Texto de b√∫squeda -->
    <div id="searching-text" class="searching-text">
        BUSCANDO RIVAL<span class="loading-dots"></span>
    </div>

    <!-- Mensaje si no se encuentra rival -->
    <div id="rival-error-message" style="text-align:center; margin-top:20px; color:red; font-weight:600; display:none;">
        No se encontr√≥ rival :(
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    let stompClient = null;
    let rivalEncontrado = false;
    let idPartidaGlobal = null;
    const usuarioId = /*[[${jugador.id}]]*/ 0;
    const usuarioNombre = /*[[${jugador.nombreUsuario}]]*/ 'defaultUser'; // Asegurate que este valor exista y tenga el nombre de usuario logueado
    let modoJuego = /*[[${modoJuego}]]*/ 'CLASICO';

    document.addEventListener('DOMContentLoaded', function () {
        console.log("modoJuego:", modoJuego);

        const socket = new SockJS(/*[[@{/chat-websocket}]]*/ '/spring/chat-websocket');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Conectado: ' + frame);

            stompClient.subscribe('/user/queue/partida', function (mensaje) {
                console.log("üì¨ Mensaje recibido en /user/queue/partida:", mensaje.body);

                let rival = JSON.parse(mensaje.body);

                // FILTRO: Ignorar si el mensaje es del mismo jugador
                if (rival.nombreUsuario === usuarioNombre) {
                    console.log("Mensaje recibido con datos propios, se ignora.");
                    return;
                }

                rivalEncontrado = true;
                console.log("JugadorDTO recibido:", rival);
                idPartidaGlobal = rival.idPartida;

                document.querySelector('.rival-name').textContent = rival.nombreUsuario;
                document.querySelector('.question-mark').style.display = 'none';

                const rivalAvatar = document.getElementById('rival-avatar');
                rivalAvatar.src = rival.linkAvatar;
                rivalAvatar.style.display = 'block';

                const rivalLevelBadge = document.querySelector('.player-container:last-child .badge-number');
                if (rivalLevelBadge && rival.nivel) {
                    rivalLevelBadge.textContent = rival.nivel;
                }

                document.getElementById('searching-text').style.display = 'none';

                console.log("üì° Suscripci√≥n a /user/queue/partida hecha."); // Confirmo la suscripci√≥n
            });

            const partidaRequest = {
                usuarioId: usuarioId,
                modoJuego: modoJuego
            };

            stompClient.send("/app/crearOUnirsePartida", {}, JSON.stringify(partidaRequest));
            console.log("Mensaje enviado:", partidaRequest);
        });

        let countdown = 20;
        const interval = setInterval(() => {
            countdown--;
            if (countdown <= 0 && !rivalEncontrado) {
                clearInterval(interval);
                document.getElementById('searching-text').style.display = 'none';
                document.getElementById('rival-error-message').style.display = 'block';

                if (idPartidaGlobal) {
                    fetch(`/partida/finalizarPartida?idPartida=${idPartidaGlobal}`, {
                        method: 'POST'
                    }).then(res => {
                        if (res.ok) {
                            console.log("‚úÖ Partida finalizada por falta de rival");
                            window.location.href = '/home';  // Redirige manualmente en JS
                        } else {
                            console.error("‚ùå No se pudo finalizar la partida");
                        }
                    }).catch(err => {
                        console.error("‚ùå Error al finalizar partida:", err);
                    });
                }
            }
        }, 2000);
    });
    /*]]>*/
</script>



</body>
</html>
